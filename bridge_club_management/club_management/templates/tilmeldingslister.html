<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tilmeldingslister</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.2.2/dist/cdn.min.js" defer></script>
  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-gray-100">
  {% include 'navbar.html' %}
  <div class="container mx-auto my-8" x-data="tilmeldingslister">
    <div class="bg-white shadow-lg rounded-lg p-8 mb-8">
      <div class="text-lg ck-content">{{ tilmeldingslister_text|safe }}</div>
    </div>
    <div class="bg-white shadow-lg rounded-lg p-8 mb-8">
      <h2 class="text-2xl font-bold mb-4">Tilmeldingslister</h2>

      <!-- Dropdown to select lists -->
      <div class="mb-4">
        <label for="list_id" class="block text-lg font-medium text-gray-700">Vælg liste:</label>
        <select name="list_id" id="list_id" x-model="selectedListId" @change="showSelectedList(); updateUrl()"
          class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          {% for liste in tilmeldingslister %}
            <option value="{{ liste.id }}" {% if liste.id == selected_list.id %}selected{% endif %}>
              {{ liste.name }} - {{ liste.day }}
            </option>
          {% endfor %}
        </select>
      </div>

      {% for liste in tilmeldingslister %}
        <div x-show="selectedListId == '{{ liste.id }}'" class="mb-4 bg-gray-50 p-4 rounded-lg shadow-sm">
          <h3 class="text-xl font-bold">{{ liste.name }}</h3>
          <p><strong>Ansvarlig:</strong> {{ liste.responsible_person.username }} ({{ liste.responsible_person.email }})</p>
          <p><strong>Tidspunkt:</strong> {{ liste.day }}</p>
          <p><strong>Frist:</strong> {{ liste.deadline }}</p>
          <p><strong>Antal pladser (par):</strong> {{ liste.antal_par }}</p>

          <!-- Tilmeldte par table -->
          <h3 class="text-lg font-bold mt-6">Tilmeldte Par</h3>
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parnummer</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Navn</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Makker</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for pair in liste.tilmeldte_par %}
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">{{ pair.parnummer }}</td>
                  <td class="px-6 py-4 whitespace-nowrap">{{ pair.navn }}</td>
                  <td class="px-6 py-4 whitespace-nowrap">{{ pair.makker }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- Venteliste table -->
          <h3 class="text-lg font-bold mt-6">Venteliste</h3>
          <p class="text-sm text-gray-600">I tilfælde af for mange tilmeldte vil de ekstra par blive vist herunder. En anden grund til at blive placeret på venteliste er hvis der er et ulige antal tilmeldte par, så vil det sidst tilmeldte par blive sat på venteliste indtil der kommer endnu en tilmelding, således at der vil være et lige antal tilmeldte par.</p>
          <table class="min-w-full divide-y divide-gray-200 mt-2">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parnummer</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Navn</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Makker</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for pair in liste.venteliste_par %}
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">{{ pair.parnummer }}</td>
                  <td class="px-6 py-4 whitespace-nowrap">{{ pair.navn }}</td>
                  <td class="px-6 py-4 whitespace-nowrap">{{ pair.makker }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- Spillere uden makker table -->
          <h3 class="text-lg font-bold mt-6">Spillere uden makker</h3>
          <table class="min-w-full divide-y divide-gray-200 mt-2">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Navn</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefonnummer</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for player in liste.single_players %}
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">{{ player.navn }}</td>
                  <td class="px-6 py-4 whitespace-nowrap">{{ player.telefonnummer }}</td>
                  <td class="px-6 py-4 whitespace-nowrap">{{ player.email }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- Conditional Buttons -->
          {% now "Y-m-d H:i:s" as current_datetime %}
          {% if liste.deadline|date:"Y-m-d H:i:s" > current_datetime %}
            <!-- Add pair button -->
            <button @click="openModal('pair')" class="mt-6 bg-blue-500 text-white px-4 py-2 rounded mr-2">Tilføj Par</button>
            <!-- Add single player button -->
            <button @click="openModal('single')" class="mt-6 bg-green-500 text-white px-4 py-2 rounded">Tilføj enkelt spiller</button>
          {% else %}
            <!-- Deadline exceeded button -->
            <button class="mt-6 bg-red-500 text-white px-4 py-2 rounded cursor-not-allowed" disabled>Frist overskredet</button>
          {% endif %}
        </div>
      {% endfor %}

      <!-- Add pair/single player form modal -->
      <div x-show="formModalOpen" @click.away="closeModal()" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full" x-cloak>
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
          <div class="absolute top-0 right-0 mt-4 mr-4">
            <button @click="closeModal()" class="text-gray-400 hover:text-gray-600">
              <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <h3 class="text-lg font-bold mb-4" x-text="modalType === 'pair' ? 'Tilføj Par' : 'Tilføj enkelt spiller'"></h3>
          <form method="post" class="space-y-4" @submit.prevent="submitForm">
            {% csrf_token %}
            <input type="hidden" name="list_id" :value="selectedListId">
            <input type="hidden" name="is_single" :value="modalType === 'single'">
            <div>
              <label for="player1_name" class="block text-sm font-medium text-gray-700">Navn:</label>
              <input type="text" name="player1_name" x-model="player1Name" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" required>
            </div>
            <div x-show="modalType === 'pair'">
              <label for="player2_name" class="block text-sm font-medium text-gray-700">Makker:</label>
              <input type="text" name="player2_name" x-model="player2Name" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" :required="modalType === 'pair'">
            </div>
            <div>
              <label for="phone_number" class="block text-sm font-medium text-gray-700">Telefonnummer:</label>
              <input type="tel" name="phone_number" x-model="phoneNumber" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" pattern="\d{8}" title="Telefonnummer skal være 8 cifre langt" required>
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700">Email:</label>
              <input type="email" name="email" x-model="email" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" required>
            </div>
            <div>
              <button type="submit" class="w-full bg-blue-500 text-white px-4 py-2 rounded" x-text="modalType === 'pair' ? 'Tilmeld Par' : 'Tilmeld Enkelt Spiller'"></button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('tilmeldingslister', () => ({
        selectedListId: '{{ selected_list.id }}',
        formModalOpen: false,
        modalType: 'pair',
        player1Name: '',
        player2Name: '',
        phoneNumber: '',
        email: '',
        init() {
          this.showSelectedList();
        },
        showSelectedList() {
          document.querySelectorAll('[x-show]').forEach(el => el.style.display = 'none');
          const selectedList = document.querySelector(`[x-show="selectedListId == '${this.selectedListId}'"]`);
          if (selectedList) {
            selectedList.style.display = 'block';
          }
        },
        updateUrl() {
          const url = new URL(window.location);
          url.searchParams.set('selected_list_id', this.selectedListId);
          window.history.pushState({}, '', url);
        },
        openModal(type) {
          this.modalType = type;
          this.formModalOpen = true;
          this.resetForm();
        },
        closeModal() {
          this.formModalOpen = false;
          this.resetForm();
        },
        resetForm() {
          this.player1Name = '';
          this.player2Name = '';
          this.phoneNumber = '';
          this.email = '';
        },
        submitForm() {
          if (this.validateForm()) {
            document.querySelector('form').submit();
          }
        },
        validateForm() {
          if (this.phoneNumber.length !== 8) {
            alert('Telefonnummer skal være 8 cifre langt');
            return false;
          }
          if (this.modalType === 'pair' && !this.player2Name.trim()) {
            alert('Makker navn er påkrævet for par tilmelding');
            return false;
          }
          return true;
        }
      }));
    });
  </script>
</body>
</html>